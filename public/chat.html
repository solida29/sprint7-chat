<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />

    <title>Chat - Socket IO</title>
  </head>
  <body>
    <div id="chatbot">
      <ul id="messagesDiv"></ul>
      <form id="form" action="">
        <div>
          <input type="text" id="messageInput" autocomplete="off" />
          <button>Send</button>
        </div>
        <div>
          <span id="roomText">Room</span>
          <input type="text" id="roomInput" autocomplete="off" />
          <button type="button" id="roomButton">Join</button>
        </div>
        <div><button id="toggle-btn">Logout</button></div>
      </form>
    </div>

    <script src="/socket.io/socket.io.js" ;></script>
    <script>
      const socket = io();

      //----- Authentication ------------
      // const socket = io({
      //   auth: {
      //     token: 'YOUR_JWT'
      //   }
      // });

      // chat message event
      const form = document.getElementById('form');
      const messagesDiv = document.getElementById('messagesDiv'); // div de todos los msg del chat
      const messageInput = document.getElementById('messageInput');
      const joinRoomButton = document.getElementById('roomButton');
      const toggleButton = document.getElementById('toggle-btn');

      // decodificamos la cookie
      function decodeCookie(nombre) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          const separateCookie = cookie.indexOf('=');
          const nombreCookie = cookie.substring(0, separateCookie);
          const valorCookie = cookie.substring(separateCookie + 1);

          if (nombreCookie === nombre) {
            return decodeURIComponent(valorCookie);
          }
        }
        return null;
      }

      // función para mostrar mensajes
      function displayMessage(msg, username) {
        const item = document.createElement('li');
        item.textContent = username + ': ' + msg;
        messagesDiv.appendChild(item);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        //window.scrollTo(0, document.body.scrollHeight);
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault(); // evita que la página se recargue, que es el comportamiento predeterminado cuando se envía un formulario.
        const username = decodeCookie('username');
        const message = messageInput.value;
        const room = roomInput.value;

        if (message) {
          socket.emit('chat-message', (username, message, room));
          messageInput.value = ''; // Borra el campo de entrada después de que el mensaje se ha enviado.
        }
      });

      joinRoomButton.addEventListener('click', () => {
        const room = roomInput.value;
        socket.emit('join-room', room, (joinedMessage) =>
          displayMessage(joinedMessage, username)
        );
      });

      // when we capture a chat message event we’ll include it in the page.
      // socket.on('chat-message', (msg) => {
      //  displayMessage(msg);
      // });

      // toggle button disconnect
      toggleButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (socket.connected) {
          toggleButton.innerText = 'Connect';
          socket.disconnect();
        } else {
          toggleButton.innerText = 'Disconnect';
          socket.connect();
        }
      });
    </script>
  </body>
</html>
